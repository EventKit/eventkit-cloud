version: '2'
services:
  base:
     volumes:
       - ./eventkit_cloud:/var/lib/eventkit/eventkit_cloud
       - ./exports_download:/var/lib/eventkit/exports_download
     build:
       context: .
     environment:
        - DATABASE_URL=postgis://eventkit:eventkit_exports@postgis:5432/eventkit_exports
        - BROKER_URL=amqp://guest:guest@rabbitmq:5672/
        - DEBUG=True
        - C_FORCE_ROOT=True
        - DEVELOPMENT=True
        - SITE_NAME=cloud.eventkit.dev
        - EXPORT_DOWNLOAD_ROOT=/var/lib/eventkit/exports_download
     command: echo 'Base box is not used, exiting now'
     #entrypoint:
        #- bash -c '/var/lib/eventkit/scripts/wait-for-postgis.sh postgres://eventkit:eventkit_exports@postgis:5432/eventkit_exports'
  eventkit:
      extends:
        service: base
      depends_on:
        - postgis
        - rabbitmq
      links:
        - postgis
        - rabbitmq
      extra_hosts:
        - "cloud.eventkit.dev:127.0.0.1"
      expose:
        - "6080"
      command: sh /var/lib/eventkit/scripts/eventkit-entrypoint.sh
  celery:
      extends:
        service: base
      depends_on:
        - postgis
        - rabbitmq
        - eventkit
      links:
        - postgis
        - rabbitmq
      command: sh /var/lib/eventkit/scripts/celery-entrypoint.sh
  postgis:
    image: mdillon/postgis
    environment:
      - POSTGRES_USER=eventkit
      - POSTGRES_PASSWORD=eventkit_exports
      - POSTGRES_DB=eventkit_exports
    ports:
     - "5432:5432"
  rabbitmq:
     image: rabbitmq
     expose:
       - "5672"
  httpd:
     build:
       context: .
       dockerfile: Dockerfile_httpd
     volumes:
       - ./eventkit_cloud:/var/lib/eventkit/eventkit_cloud
       - ./exports_download:/var/lib/eventkit/exports_download
     image: httpd
     ports:
        - "80:80"
